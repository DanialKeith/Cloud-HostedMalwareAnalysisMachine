# Cloud-Hosted Malware Analysis Machine

## Introduction
This report outlines the setup of a versatile malware analysis lab hosted on AWS. It utilizes Terraform for streamlined setup and FlareVM for detailed malware examination, offering a lab that is both adaptable in operation and robust in its analysis capabilities.
## Lab Creation Process
### 1. Initial AWS Setup
- **Windows Instance Setup:**
  - Selected Microsoft Windows Server 2022 Base as the AMI.
  - Opted for a t2.medium instance with public VPC and RDP accessibility.
  
  ![image](https://github.com/DanialKeith/Cloud-HostedMalwareAnalysisMachine/assets/154257195/b7329fba-99a2-47da-ac2c-0f9345114f63)


  - Generated a key pair.
  - Ensured RDP traffic was open to all sources (0.0.0.0/0).

    
  ![image](https://github.com/DanialKeith/Cloud-HostedMalwareAnalysisMachine/assets/154257195/4e16655a-4d4f-45eb-889f-6a05108ad163)

  -	Expanded storage to 60 GB for ample space.
    
  ![image](https://github.com/DanialKeith/Cloud-HostedMalwareAnalysisMachine/assets/154257195/2b616d9a-78d8-40bf-88bf-2e36161a3f53)


### 2. FlareVM Configuration
-	**Installation and Access:**
    -	Secured RDP access to the instance after retrieving the password.
![image](https://github.com/DanialKeith/Cloud-HostedMalwareAnalysisMachine/assets/154257195/95ec1651-f08b-4c4e-a490-81275a30be46)

    -	Installed FlareVM with a sequence of PowerShell commands:
    
  ```
 Unblock-File .\install.ps1
  Set-ExecutionPolicy Unrestricted
.\install.ps1
   ```
![image](https://github.com/DanialKeith/Cloud-HostedMalwareAnalysisMachine/assets/154257195/0af0839a-605a-4244-b227-2c080f6fe119)

### 3. Creating the Windows IAM with FlareVM
- **IAM Configuration:**
  - Stopped the EC2 instance post-FlareVM setup.
  - Created a ‘flare-vm’ image.
    
  ![image](https://github.com/DanialKeith/Cloud-HostedMalwareAnalysisMachine/assets/154257195/78ae0418-de30-4403-89d3-385f8d632764)

  - Configured an IAM in AWS, recording the IAM ID and AWS Access keys for future use.
  
### 4. Terraform Configuration for Lab Management
-	Configured an IAM user with comprehensive AmazonEC2FullAccess permissions.
## Cloud-Hosted Lab Architecture
### Requirements
-	A UNIX/Linux terminal-equipped workstation.
-	Installation of Terraform [(Terraform Installation Guide)](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli), JQ [(JQ GitHub Repository)](https://github.com/adanalvarez/AWS-malware-lab), and AWSCLI.
-	An active AWS account for deployment.
### Configuration and Deployment
-	**Lab Configuration:**
    -	Cloned the AWS-malware-lab repository from [adanalvarez's GitHub](https://github.com/adanalvarez/AWS-malware-lab).
    -	Set up a configuration file named shared.auto.tfvars.json.
    ```      
    {
    "environment": "malware-lab",
    "ami": "ami-xxxxxxxxxxxxxxxxx",
    "account" : "xxxxxxxxxxxx",
    "region": "us-east-1",
    "enable_guacamole": false,
    "enable_inetsim": true
    }
    ```
    -	Configured AWS.
      
![image](https://github.com/DanialKeith/Cloud-HostedMalwareAnalysisMachine/assets/154257195/69b82794-e620-45a5-84b5-7d62b23da551)


 
### Lab Setup Procedure
-	**Environment Provisioning with INETSIM and Terraform:**
    -	Aligned ``main.tf`` with the locally installed version of my machine.
    - Updated ``instances.tf`` with the default AMI of Ubuntu.
    -	Updated ``network.tf`` to change the availability zone to ``us-east-1a``.
    -	Ran Terraform commands for environment setup:
      
    ```
    terraform init
    terraform plan
    terraform apply
    ```

    -	Documented the public IP address of the FlareVM machine.

 ![image](https://github.com/DanialKeith/Cloud-HostedMalwareAnalysisMachine/assets/154257195/92211d14-3b0a-4877-818f-886db2afbd61)

### Activating INETSIM within the VM
-	Implemented INETSIM by setting DNS via the command ``Get-NetAdapter -Name "Ethernet 2" | Set-DnsClientServerAddress -ServerAddresses "172.16.10.6"``.
-	Verified secure internet simulation by navigating to google.com under INETSIM's protection.

![image](https://github.com/DanialKeith/Cloud-HostedMalwareAnalysisMachine/assets/154257195/4dd695e4-7e56-4f5b-8242-74a613ff3240)

## Conclusion
This report clearly explains how to set up a practical and effective malware analysis lab in AWS. By using Terraform for automation and FlareVM for detailed analysis, this lab is well-equipped to handle thorough malware investigations. Its flexible design makes it a great solution for a wide range of malware analysis needs.



**Special thanks** to [adanalvarez's AWS-malware-lab](https://github.com/adanalvarez/AWS-malware-lab) for providing foundational resources and guidance.

